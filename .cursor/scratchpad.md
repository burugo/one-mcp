# One MCP Service Development Plan

## Background and Motivation

The goal is to develop an One MCP (Multi-Cloud Platform) Service. This service acts as a central hub for managing and proxying various underlying MCP services (types: `stdio`, `sse`, `streamable_http`). Users configure these underlying services and then access them through unified SSE or Streamable HTTP endpoints provided by this One MCP service. Users create "MCP Setups" (configuration sets) containing multiple service instances. A key feature is exporting these setups into JSON formats specific to different client applications (e.g., Cursor, Cherry-Studio). The exported configurations will always point to the One MCP service's proxy endpoints, and the protocol used by these proxy endpoints (SSE or Streamable HTTP) is determined by the chosen client application type at export time.

This simplified approach streamlines export by tying the proxy protocol choice directly to the client type.

**New: MCP Server Installation User Experience**
The project will also include a user interface for discovering and installing MCP servers, similar to the experience in C-Line and Cherry Studio.
- **User Interface**: A dedicated UI will allow users to browse and search for available MCP servers.
- **Marketplace Integration**:
    - Users will be able to search for MCP servers from public marketplaces like npm (Node Package Manager) and PyPI (Python Package Index).
    - The system will initially feature a curated list of built-in/recommended servers.
- **Installation Mechanism**:
    - Upon selecting a server, the system will use the appropriate command-line tool to install it:
        - `npx` for npm packages (partially supported in backend).
        - `uvx` (or equivalent like `pip install`) for PyPI packages (backend support to be added).
    - The installed server will then be available within the One MCP system for users to configure and use.

The system needs to support:
- Admins defining abstract MCP Service types (`MCPService`), including:
    - The underlying type of the service (`stdio`, `sse`, `streamable_http`).
    - Schemas for admin-level and user-level configurations.
    - Default values for admin configurations.
    - Rules on user overrides.
    - `ClientConfigTemplates` (JSON/TEXT): A map where keys are `client_type` strings (e.g., "cursor", "cherry_studio"). Each value is an object with:
        - `template_string` (string): The Go template for the client-specific JSON snippet.
        - `client_expected_protocol` (string): The protocol type (e.g.,"sse", "streamable_http", "stdio") the client expects for this service entry in its config file.
        - `our_proxy_protocol_for_this_client` (string): The protocol ("sse" or "streamable_http") One MCP service will use for its proxy endpoint when exporting for this `client_type`. This directly dictates the format of the proxy URL generated by the template (e.g., `base_url/:instance_id/sse` or `base_url/:instance_id/mcp`).
- Users creating `UserConfig` (MCP Setups), adding `ConfigService` instances, and providing `UserOverrideConfigValues`.
- Users exporting an MCP Setup for a chosen `client_type`, triggering a backend process to:
    1. Retrieve service instances.
    2. Calculate effective configurations for each underlying service.
    3. For each instance, use the `ClientConfigTemplates` for the target `client_type`:
        - The `our_proxy_protocol_for_this_client` field from the template detail determines the `effective_our_proxy_protocol`.
        - Render the `template_string`, providing it with data including the effective config of the underlying service and the `effective_our_proxy_protocol`. The template will generate a snippet matching `client_expected_protocol`. The URLs within this snippet will point to One MCP's proxy, constructed using `effective_our_proxy_protocol` (e.g., using `/sse` or `/mcp` path segments).
    4. Aggregate snippets into the final client JSON.

## Key Challenges and Analysis

- **Complex Data Modeling**: Accurately defining `MCPService` (esp. the simplified `ClientConfigTemplates`), `UserConfig`, `ConfigService`.
- **Configuration Merging Logic**: For admin defaults and user overrides.
- **Dynamic Template-Based Transformation**: Templates must:
    - Be selected by `client_type`.
    - Generate snippets matching `client_expected_protocol`.
    - Construct proxy URLs using `our_proxy_protocol_for_this_client` to determine the correct path segment (e.g., `/sse` or `/mcp`).
- **Schema Definition and Validation**: For config schemas.
- **Proxying Logic**: Runtime proxy for `stdio`, `sse`, `streamable_http` underlying services.
   - SSE services accessed via `/api/sse/:serviceName`.
   - Streamable HTTP services accessed via `/api/http/:serviceName`.
   - `:serviceName` is the unique name of the service instance.
- **API Design**: For Admin, User, and Export. Proxy endpoints are now `/api/sse/:serviceName` and `/api/http/:serviceName`.

**New Challenges for Server Installation Feature:**
- **Multi-Package Manager Integration**: Securely and reliably executing external commands (`npx`, `uvx`) to install packages from different ecosystems. Managing their outputs and error states. (Backend support for `uvx`/`pip` needs to be added/enhanced).
- **Marketplace Search Aggregation & UI**: Designing a user-friendly interface to search across multiple marketplaces (npm, PyPI) and display results effectively. Handling potential differences in package metadata.
- **Installation State Management**: Tracking the installation status of servers and reflecting this in the UI and backend (largely in place, may need refinement for PyPI).
- **Dependency Management**: Ensuring that installed servers and their dependencies do not conflict with the One MCP system or other installed servers. (This might be a longer-term consideration).
- **Post-Installation Database Logic**: Ensuring `MCPService` and `ConfigService` records are correctly created/updated in the database after successful installation for all supported package managers.
- **Subtle Page Width Changes**: Investigating and resolving minor page width inconsistencies.
    - **Initial thought**: Caused by scrollbar appearance/disappearance. Global fix `overflow-y-scroll` on `<main>` helped.
    - **Current Hypothesis (Services Page Tabs)**: The width change when switching tabs (e.g., "All Services" vs "Active") on the `ServicesPage` might be due to the tab content's intrinsic width. If a tab's content is narrow (like a short paragraph in "Active"), its container might shrink, causing a perceived page width change, even with `w-full` on parent elements. The `TabsContent` for "All Services" (grid of cards) is wider and might set a different baseline.
    - **Service Name Uniqueness**: Ensuring the `name` field for service instances is unique will be critical for the new routing scheme.
    - Handling services like 'exa-mcp-server' which are fundamentally `stdio` but need to be exposed via an SSE endpoint. This requires the backend to use the `mcp-go` library to wrap the `stdio` client with an `mcp-go` SSE server.
    - Managing `mcp-go` client/server lifecycles within the One MCP backend when proxying `stdio` services.
    - Retrieving `stdio` configuration (command, args, env) for `MCPService` records from their stored configuration (e.g., `DefaultAdminConfigValues` or effective user config).

**Challenges for Marketplace UI Finalization:**
- Ensuring seamless integration of `ServiceCard.tsx` into `MarketPage.tsx`, including proper data flow and event handling (`onSelect`, `onInstall`).
- Verifying that all service information displays correctly under various conditions (e.g., missing optional data like GitHub stars).
- Confirming that the installation initiation from the card works as expected and UI updates reflect installation status.

## High-level Task Breakdown (Feature: MCP Setup Management & Export with Proxying)

### 1. Core Model Redesign & Implementation
    - **1.1**: Define/Refactor `MCPService` GORM model: `Task Type: New Feature`
        - Fields: `ID`, `Name`, `DisplayName`, `Type` (enum: `stdio`, `sse`, `streamable_http`), `AdminConfigSchema`, `DefaultAdminConfigValues`, `UserConfigSchema`, `AllowUserOverride`, `ClientConfigTemplates` (JSON/TEXT - map of `client_type` to `{ template_string, client_expected_protocol, our_proxy_protocol_for_this_client }`).
        - Success Criteria: Model defined. `ClientConfigTemplates` stores new simplified structured JSON.
    - **1.2**: Define/Refactor `UserConfig` GORM model. `Task Type: New Feature`
    - **1.3**: Define/Refactor `ConfigService` GORM model. `Task Type: New Feature`
    - **1.4**: Implement GORM `AutoMigrate`. `Task Type: New Feature`

### 2. Admin: MCPService Definition Management
    - **2.1**: APIs for Admin to CRUD `MCPService` (including new `ClientConfigTemplates` structure). `Task Type: New Feature`

### 3. User: MCP Setup & Service Instance Management
    - **3.1**: Design & Implement APIs for User to CRUD `UserConfig` (MCP Setups). `Task Type: New Feature`
    - **3.2**: Design & Implement APIs for User to CRUD `ConfigService` (Service Instances). `Task Type: New Feature`
    - **3.3**: Implement logic for handling multi-value inputs. `Task Type: New Feature`

### 4. Core: Configuration Merging & Client Export Logic
    - **4.1**: Implement "Effective Configuration" calculation. `Task Type: New Feature`
    - **4.2**: Design & Implement API for Exporting `UserConfig`: `Task Type: New Feature`
        - Endpoint: `GET /api/mcp_setups/:setup_id/export?client_type=<client_name>` (No `protocol` query param needed).
        - Logic: Retrieves `ClientTemplateDetail` for `client_name`. The `our_proxy_protocol_for_this_client` from this detail becomes the `effective_our_proxy_protocol`.
        - Success Criteria: API authenticates, determines `effective_our_proxy_protocol` solely from `client_type`'s template config.
    - **4.3**: Implement core transformation logic: `Task Type: New Feature`
        - For each instance:
            1. Calculate effective config.
            2. Get `ClientTemplateDetail`.
            3. `effective_our_proxy_protocol = templateDetail.our_proxy_protocol_for_this_client`.
            4. Prepare template data: effective config, `EffectiveOurProxyProtocol: effective_our_proxy_protocol`. Provide means for template to construct correct proxy URL (e.g., by passing base proxy path and `effective_our_proxy_protocol` which template uses to append `/sse` or `/mcp`).
            5. Render `templateDetail.template_string` generating snippet consistent with `templateDetail.client_expected_protocol`.
        - Success Criteria: Generates correct client snippets with proxy URLs reflecting the client-fixed protocol.
    - **4.4**: Implement aggregation. `Task Type: New Feature`

### 5. Core: Service Proxying Runtime
    - **5.1**: Adapt proxy endpoint design to use service names. `Task Type: ref-struct`
        - SSE: `/api/sse/:serviceName`
        - Streamable HTTP: `/api/http/:serviceName`
        - `:serviceName` is the unique name of the service instance.
    - Success Criteria: Backend routes are updated to handle these new URL patterns. Proxy logic correctly uses `serviceName` for lookup.
    - **5.2**: Implement request handling logic for proxy endpoints. `Task Type: New Feature`
    - **5.3**: Implement dispatch logic based on `MCPService.Type` of the underlying service. `Task Type: New Feature`
    - **5.4**: Handle parameter mapping and passing. `Task Type: New Feature`
    - Success Criteria: One MCP service can proxy to underlying services, exposing them via SSE or Streamable HTTP as determined during client config export.

### 6. Testing & Documentation
    - **6.1**: Write unit tests. `Task Type: New Feature`
    - **6.2**: Write integration tests. `Task Type: New Feature`
    - **6.3**: Update API documentation. `Task Type: Refactoring (Functional)`
    - **6.4**: Add code comments. `Task Type: Refactoring (Functional)`

### 7. UI for MCP Server Installation (New Feature Section)
    - **7.1**: Design and implement MCP Server Installation UI (See `.cursor/feature-mcp-installer-ui.md` for details). `Task Type: New Feature`
        - Sub-tasks: UI Mockups, Frontend Component Development, Backend APIs for search & installation, Frontend-Backend Integration, State Management, Testing.
        - Success Criteria: Users can search for MCP servers from npm & PyPI, view details, and trigger installation via `npx`/`uvx` through a user-friendly interface.

### 8. UI Implementation for MCP Installer (Next Major Task)
    - **8.1**: See `.cursor/feature-mcp-installer-ui.md` for detailed UI implementation plan and tasks. `Task Type: New Feature`

### 9. Frontend Routing and Structure Refactor (New Task)
    - **9.1**: Refactor frontend to use `react-router-dom` and separate page components. `Task Type: ref-struct`
        - Sub-tasks: Install `react-router-dom`, create `pages` directory, create page components, migrate content, set up routing in `App.tsx`, update navigation links, remove `currentPage` state.
        - Success Criteria: Application uses URL-based routing, `App.tsx` is cleaner, page logic is modularized.
    - **9.2**: Fix Services page tab width inconsistency. `Task Type: bug-fix`
        - Sub-tasks:
            - **Investigate Computed Widths**: Using browser dev tools, inspect computed widths of `<main>`, `ServicesPage` root div, `<Tabs>`, and `<TabsContent>` elements when switching between "All", "Active", and "Inactive" tabs. Note any changes.
            - **Test with Wider "Active" Content**: Temporarily add wider content (e.g., a long paragraph or a copy of the service grid) to the "Active" tab's `TabsContent` to see if this stabilizes the width.
            - **Test `w-full` on `TabsContent`**: Experimentally add `w-full` to `TabsContent` components to see if it forces them to occupy the full parent width.
            - Implement a CSS or structural fix based on findings (e.g., `min-width` on `TabsContent` or ensuring `Tabs` component itself maintains a consistent width).
        - Success Criteria: Page width remains consistent when switching tabs on the `ServicesPage`.

### 10. UI Polish and Bug Fixing (New Task)
    - **10.1**: Address UI bugs and implement minor UI enhancements. See `.cursor/ui-polish-tasks.md` for details. `Task Type: bug-fix`

### 11. Feature: Backend Support for MCP Server Installation (npm, PyPI/uvx)
    - **11.1**: Implement backend logic for installing MCP servers from npm (enhance existing) and PyPI/uvx (new). See `.cursor/feature-backend-installer.md` for details. `Task Type: new-feat`
    - **Success Criteria**: Backend can reliably install packages using npx and uvx/pip, manage installation state, and update database records. Frontend can integrate with these backend APIs.

### 12. Frontend: Service Card Display Refinement (New Task)
    - **12.1**: Refine the display of information on the `ServiceCard` component in the marketplace. See `.cursor/feature-service-card-refine.md` for details. `Task Type: ref-func`
    - **Success Criteria**: Service cards accurately reflect desired information like GitHub homepage, adjusted star/author display, and removal of download counts. (Status: Completed)

### 13. Frontend: Finalize Marketplace UI (Integrate ServiceCard, Test) (New Task)
    - **13.1**: Integrate `ServiceCard.tsx` into `MarketPage.tsx` and conduct comprehensive UI testing. See `.cursor/feature-marketplace-ui-finalization.md` for details. `Task Type: new-feat`
    - **Success Criteria**: Marketplace UI uses the new `ServiceCard.tsx`, displays information correctly, and all user interactions (search, select, install) are functional and smooth.

### 14. Backend: Implement GitHub Data Fetching (Stars, Author) (Future Task)
    - **14.1**: Enhance backend to fetch GitHub stars and potentially parse author information from GitHub repository URLs. Define a task file (e.g., `.cursor/feature-backend-github.md`) when this becomes active. `Task Type: new-feat`
    - **Success Criteria**: Backend marketplace API provides GitHub stars and improved author information for services where applicable.

### 15. Frontend: Login Experience Refactor (Completed)
    - **15.1**: Standardize UI/UX for standalone login page and login modal, ensure correct token persistence. See `.cursor/login-refactor-tasks.md` for details. `Task Type: ref-struct/new-feat/bug-fix`
    - **Success Criteria**: Login page and modal are visually and functionally identical; token handling is correct and robust.

### 16. Feature: Service Uninstallation (Active)
    - **16.1**: Implement the ability for users to uninstall services from the marketplace. See `.cursor/feature-uninstall-service-tasks.md` for details. `Task Type: new-feat`
    - **Success Criteria**: Users can successfully uninstall services, with appropriate feedback and state changes in UI and backend.

### 17. Backend: Adapt Proxy Endpoints to New URL Structure (New Task)
    - **17.1**: Modify backend routing to handle `GET /api/sse/:serviceName` for SSE services. `Task Type: ref-struct`
    - **17.2**: Modify backend routing to handle `GET /api/http/:serviceName` (and other relevant methods) for Streamable HTTP services. `Task Type: ref-struct`
    - **17.3**: Ensure service lookup within proxy handlers uses the `serviceName` from the path. `Task Type: ref-func`
    - **17.4**: Add or verify mechanisms to ensure uniqueness of the `service.name` field for `ConfigService` instances. `Task Type: new-feat` (if new validation) or `ref-func` (if enhancing existing).
    - See `.cursor/backend-url-refactor-tasks.md` for details.

## Project Status Board

Active Task File: `.cursor/backend-url-refactor-tasks.md`
Current Focus: Stdio to SSE Proxy for `exa-mcp-server` - Implementation Complete, pending testing.
Next Up: Testing of Stdio to SSE proxy, then address other pending tasks (HTTP proxy, native SSE proxy, lifecycle management).

Relevant Task Files:
*   `.cursor/login-refactor-tasks.md`: Login experience refactor (All tasks completed).
*   `.cursor/feature-uninstall-service-tasks.md`: Service Uninstallation feature.
*   `.cursor/feature-service-card-refine.md`: (Status: Completed)
*   `.cursor/feature-marketplace-ui-finalization.md`: Frontend work to integrate ServiceCard.tsx and test marketplace UI.
*   `.cursor/generate-description-plan-mode-tasks.md`: Meta-task to generate description for `plan-mode.mdc`.
*   `.cursor/backend-url-refactor-tasks.md`: Adapt backend proxy URLs (Active).

# One MCP AI Agent Scratchpad

## Background and Motivation

User wants to unify the login experience between the standalone `/login` page and the login modal. Currently, they differ in UI and token handling, with the `/login` page not correctly persisting the token to the global state (AuthContext).
Additionally, user requested a new feature to uninstall services from the marketplace, and visual enhancements for the installation process (toast notification and a success checkmark animation).

## Key Challenges and Analysis

**Login Refactor:**
1.  **UI/UX Unification**: `Login.tsx` needs to replicate or reuse the visual and interactive elements of `login-dialog.tsx`.
2.  **Logic Reusability**: `login-dialog.tsx` contains form handling, API calls, error management, and global state updates via `useAuth().login`. `Login.tsx` must use this logic.
3.  **Token Persistence**: Ensure `/login` page uses `useAuth().login` for consistent token handling in `localStorage` and `AuthContext`.
4.  **Component Reuse Strategy**: Recommended creating a `LoginFormCommon.tsx` to be used by both `login-dialog.tsx` (for modal) and `Login.tsx` (for standalone page).

**Service Uninstallation:**
1.  **Backend API**: Requires a new endpoint to handle uninstallation commands and database updates.
2.  **Frontend State**: `marketStore` needs to manage uninstallation status.
3.  **UI/UX**: "Uninstall" button, confirmation dialog, and feedback (toasts, loading states).

**Installation Animation:**
1.  Display a toast "Installing..." on initiation.
2.  On success, show a large, semi-transparent checkmark SVG animation in the center of the service card, which then fades out.

## High-level Task Breakdown

1.  **Create Login Form Common Component (`ref-struct`)**: è¯¦è§ `.cursor/login-refactor-tasks.md`
2.  **Refactor Login Modal (`ref-struct`)**: è¯¦è§ `.cursor/login-refactor-tasks.md`
3.  **Refactor Standalone Login Page (`new-feat` / `ref-func`)**: è¯¦è§ `.cursor/login-refactor-tasks.md`
4.  **Test and Verify (`bug-fix`)**: è¯¦è§ `.cursor/login-refactor-tasks.md`

## Project Status Board

Active Task File: `.cursor/feature-uninstall-service-tasks.md`

Relevant Task Files:
*   `.cursor/login-refactor-tasks.md`: Login experience refactor (All tasks completed).
*   `.cursor/feature-uninstall-service-tasks.md`: Service Uninstallation feature.
*   feature-service-card-refine.md: (Status: Completed)
*   feature-marketplace-ui-finalization.md: (Status: Active) Frontend work to integrate ServiceCard.tsx and test marketplace UI.

## Executor's Feedback or Assistance Requests

- **Updated visual feedback for service installation (as per Task 3.4 in `.cursor/feature-uninstall-service-tasks.md` and user request):**
    - Removed "installing" toast from `frontend/src/store/marketStore.ts`.
    - Implemented a loading spinner animation (semi-transparent overlay with `Loader2` icon) in `frontend/src/components/market/ServiceCard.tsx` that shows when `installTask.status` is 'installing'.
    - The existing "installed" success checkmark animation in `ServiceCard.tsx` will now show *after* the loading spinner disappears, if installation is successful.
    - **User Action Required (Still applies for success animation)**: Add the following CSS to your global styles for the success checkmark animation:
      ```css
      @keyframes success-tick-kf {
        0% { opacity: 0; transform: scale(0.5); }
        30% { opacity: 1; transform: scale(1.1); }
        80% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(1); }
      }
      .animate-success-tick {
        animation: success-tick-kf 2s ease-out forwards;
      }
      ```
- **Completed Task 3.1 (Add Uninstall button to ServiceCard):**
    - `ServiceCard.tsx` now shows an 'Uninstall' button for installed services.
    - This was a `ref-struct` task and user verification was implicitly received by the request to continue.

- **Completed Task 3.2 (Create ConfirmDialog component):**
    - Created `frontend/src/components/ui/ConfirmDialog.tsx` based on `shadcn/ui AlertDialog`.
    - **User Action Required**: Ensure `alert-dialog` base component from `shadcn/ui` is installed in the project (e.g., via `npx shadcn-ui@latest add alert-dialog`).

- **Completed Task 3.3 (Integrate Uninstallation Flow in `ServiceCard.tsx`):**
    - Modified `ServiceCard.tsx` to use `ConfirmDialog` when the 'Uninstall' button is clicked.
    - The `ConfirmDialog` will then trigger the `uninstallService` action from `marketStore` upon user confirmation.

- **Error Encountered (Vite import analysis - User Reported):**
    - **Error Message**: `Failed to resolve import "@/components/ui/alert-dialog" from "src/components/ui/ConfirmDialog.tsx". Does the file exist?`
    - **Reason**: The base `alert-dialog` component from `shadcn/ui` is likely missing from `frontend/src/components/ui/`.
    - **Solution Provided to User**: Advised user to run `npx shadcn-ui@latest add alert-dialog` in the project terminal to add the missing component, then retry.

- **Next Suggested Steps:**
    - Await user confirmation that the `alert-dialog` component has been added and the import error is resolved.
    - If resolved, continue with Task 3.4 (visual feedback for uninstallation).

## Lessons

*   `ClientConfigTemplates` design is crucial. Simplifying it by linking `client_type` directly to `our_proxy_protocol_for_this_client` makes the export process more deterministic and easier to manage if clients have fixed protocol preferences. Templates then need to use this to construct protocol-specific proxy URLs.
*   åœ¨ä½¿ç”¨Thing ORMæ—¶ï¼Œéœ€è¦ä¸ºæ¯ä¸ªæ¨¡åž‹åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€å˜é‡ï¼ˆå¦‚`MCPServiceDB`ï¼‰å¹¶åœ¨`InitDB`ä¸­è°ƒç”¨ç›¸åº”çš„åˆå§‹åŒ–å‡½æ•°ã€‚
*   Thing ORMä½¿ç”¨`db`æ ‡ç­¾è€Œéž`gorm`æ ‡ç­¾å®šä¹‰å­—æ®µæ˜ å°„å’Œç´¢å¼•ã€‚
*   Thing ORMæ²¡æœ‰å†…ç½®çš„`RecordNotFound`é”™è¯¯ï¼Œéœ€è¦è‡ªå®šä¹‰é”™è¯¯å¤„ç†ã€‚
*   **é”™è¯¯ä¸Ži18nå¤„ç†è§„èŒƒï¼šModelå±‚è¿”å›ži18n keyï¼ˆå¦‚`errors.New("user_not_found")`ï¼‰ï¼ŒHandlerå±‚æ ¹æ®i18n keyå’Œå½“å‰è¯­è¨€ç›´æŽ¥è°ƒç”¨i18n.T(lang, err.Error())è¿›è¡Œç¿»è¯‘å’Œå“åº”ã€‚è¿™æ ·å¯ç®€åŒ–é”™è¯¯å¤„ç†æµç¨‹ï¼Œä¾¿äºŽå¤šè¯­è¨€æ”¯æŒå’Œç»´æŠ¤ã€‚**
*   MCPServiceæ¨¡åž‹ä¸­æœªç›´æŽ¥ä½¿ç”¨thing ORMçš„ToJSONæ–¹æ³•è¿›è¡Œåºåˆ—åŒ–ï¼ŒåŽŸå› å¯èƒ½åŒ…æ‹¬ï¼š
    1. ä»…éœ€åºåˆ—åŒ–éƒ¨åˆ†å­—æ®µæˆ–åµŒå¥—ç»“æž„ï¼ˆå¦‚ClientConfigTemplatesä¸ºstringå­—æ®µï¼Œéœ€æ‰‹åŠ¨json.Marshal/mapè½¬æ¢ï¼‰ï¼Œç›´æŽ¥Marshalæ›´çµæ´»ã€‚
    2. ToJSONé€‚åˆæ ‡å‡†ç»“æž„ä½“/å…³ç³»åž‹æ•°æ®çš„çµæ´»å­—æ®µå¯¼å‡ºï¼Œè‹¥æœ‰ç‰¹æ®Šç»“æž„æˆ–è‡ªå®šä¹‰åºåˆ—åŒ–éœ€æ±‚ï¼Œæ‰‹åŠ¨å¤„ç†æ›´å¯æŽ§ã€‚
    3. ç›®å‰é¡¹ç›®æœªç»Ÿä¸€é‡‡ç”¨ToJSONï¼Œéƒ¨åˆ†åŽ†å²ä»£ç /ä¹ æƒ¯ç›´æŽ¥ç”¨encoding/jsonã€‚
    4. è‹¥åŽç»­éœ€æ”¯æŒçµæ´»å­—æ®µå¯¼å‡ºã€è™šæ‹Ÿå­—æ®µã€åµŒå¥—å…³ç³»ç­‰ï¼Œå»ºè®®ä¼˜å…ˆç”¨thing.ToJSON+WithFields DSLã€‚
*   thing ORMçš„ToJSONæ”¯æŒWithFields("field1,nested{subfield},-excluded")ç­‰çµæ´»å­—æ®µæŽ§åˆ¶ï¼Œé€‚åˆAPIå¯¼å‡ºã€å‰ç«¯å®šåˆ¶ç­‰åœºæ™¯ã€‚
*   MCPæœåŠ¡ç±»åž‹è¯´æ˜Žï¼š
    1. `ServiceTypeStdio` - æœ¬åœ°æ‰§è¡Œçš„æœåŠ¡ï¼Œé€šè¿‡stdin/stdoutä¸ŽæœåŠ¡é€šä¿¡ï¼Œé€šå¸¸é€šè¿‡åŒ…ç®¡ç†å™¨ï¼ˆnpmã€pypiç­‰ï¼‰å®‰è£…
    2. `ServiceTypeSSE` å’Œ `ServiceTypeStreamableHTTP` - å‡ä¸ºè¿œç¨‹æœåŠ¡ç±»åž‹ï¼Œé€šè¿‡ç½‘ç»œè¯·æ±‚è°ƒç”¨ï¼Œä¸éœ€è¦æœ¬åœ°å®‰è£…ã€‚å‰è€…ä½¿ç”¨SSEåè®®ä¼ è¾“æ•°æ®ï¼ŒåŽè€…ä½¿ç”¨æ”¯æŒæµå¼ä¼ è¾“çš„HTTPåè®®ã€‚
    3. ç”±äºŽSSEå’ŒStreamableHTTPæœ¬èº«å³ä¸ºè¿œç«¯æœåŠ¡ç±»åž‹ï¼Œæ— éœ€å•ç‹¬çš„`ServiceTypeRemote`ç±»åž‹ã€‚
*   Redis ç¼“å­˜æžå¤§æå‡äº† stars èšåˆæ€§èƒ½å’ŒæŠ—é™æµèƒ½åŠ›ã€‚
*   .env æ–‡ä»¶è¢« .gitignore å¿½ç•¥ï¼Œæ•æ„Ÿä¿¡æ¯ä¸åº”çº³å…¥ç‰ˆæœ¬æŽ§åˆ¶ã€‚
*   Go å•å…ƒæµ‹è¯•ç”¨ SQLite å†…å­˜æ•°æ®åº“æ—¶ï¼ŒORM å…¨å±€å’Œ model å±‚å¿…é¡»å…±ç”¨åŒä¸€ä¸ª dbAdapterï¼Œä¸èƒ½å¤šæ¬¡ newï¼Œé¿å… :memory: è¿žæŽ¥éš”ç¦»ã€‚æŽ¨èåœ¨æµ‹è¯•ç”¨ä¾‹é‡Œåª new ä¸€æ¬¡ dbAdapterï¼Œå¹¶ä¼ ç»™ ORM å’Œ modelï¼Œæ‰€æœ‰è¡¨ç»“æž„å’Œæ•°æ®æ“ä½œéƒ½åœ¨åŒä¸€è¿žæŽ¥ä¸‹å®Œæˆã€‚

## User Specified Lessons

- Include info useful for debugging in the program output.
- Read the file before you try to edit it.
- Always ask before using the -force git command
- For multi-value config items (e.g., root_path), use JSON arrays for storage and ensure UI/template logic can handle them.

- å·²ä¿®å¤ AppContent æµ‹è¯•æ–­è¨€ï¼Œå…è®¸é¡µé¢ä¸Šæœ‰å¤šä¸ª 'One MCP' å…ƒç´ ï¼Œæµ‹è¯•å·²é€šè¿‡å¹¶å·²æäº¤ã€‚

## Background and Motivation

ä¸ºæå‡æœåŠ¡å¡ç‰‡çš„æƒå¨æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œéœ€è¦åœ¨å‰ç«¯å±•ç¤º npm åŒ…å¯¹åº” GitHub ä»“åº“çš„ star æ•°ã€‚å½“å‰ npm registry API ä¸ç›´æŽ¥è¿”å›ž starsï¼Œéœ€åŽç«¯èšåˆé‡‡é›†å¹¶è¿”å›žã€‚

## Key Challenges and Analysis

- éœ€è§£æž npm åŒ… repository å­—æ®µï¼Œå…¼å®¹å¤šç§æ ¼å¼ï¼Œå‡†ç¡®æå– GitHub owner/repoã€‚
- éœ€è°ƒç”¨ GitHub API èŽ·å– starsï¼Œå¤„ç†é€ŸçŽ‡é™åˆ¶å’Œ token é…ç½®ã€‚
- éœ€ä¿è¯ stars å­—æ®µä¸Žå‰ç«¯å­—æ®µåå¯¹é½ï¼ˆgithub_starsï¼‰ã€‚
- éœ€å…œåº•å¤„ç† API å¤±è´¥ã€æ—  stars æƒ…å†µã€‚

## High-level Task Breakdown

- å‰ç«¯ UI åŠæ•°æ® mapping å·²å®Œæˆã€‚
- åŽç«¯éœ€è¡¥å…… npm åŒ… GitHub stars èšåˆé€»è¾‘ï¼ˆè¯¦è§ .cursor/feature-service-card-refine.md Task 3ï¼‰ã€‚

## Project Status Board

Active Task File: feature-service-card-refine.md
- Task 3: èšåˆå¹¶è¿”å›ž npm åŒ…çš„ GitHub starsï¼ˆIn Progressï¼‰

### ðŸŽ‰ æœåŠ¡å¡ç‰‡ GitHub stars èšåˆä¸Žç¼“å­˜é“¾è·¯â€”â€”éªŒæ”¶æ€»ç»“

1. **æ ¸å¿ƒç›®æ ‡è¾¾æˆ**
   - åŽç«¯å·²å®žçŽ° npm åŒ… GitHub stars å­—æ®µè‡ªåŠ¨èšåˆï¼Œä¼˜å…ˆç”¨ Redis ç¼“å­˜ï¼Œæžå¤§æå‡äº†æ€§èƒ½å’ŒæŠ—é™æµèƒ½åŠ›ã€‚
   - å‰ç«¯/åŽç«¯æŽ¥å£ contract å®Œå…¨å¯¹é½å­—æ®µåå’Œ contract æ»¡è¶³ UI éœ€æ±‚ã€‚
   - stars å­—æ®µèƒ½ç¨³å®šè¿”å›žçœŸå®ž star æ•°ï¼Œé‡å¤è¯·æ±‚å‘½ä¸­ç¼“å­˜ï¼ŒæŽ¥å£é«˜æ€§èƒ½ã€ä½Žå»¶è¿Ÿã€‚

2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - åªéœ€è®¾ç½® JWT_SECRETï¼Œé‡å¯åŽç«¯ä¸ä¼šå¯¼è‡´å‰ç«¯ç™»å½•æ€ä¸¢å¤±ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ã€‚

3. **ä»£ç ä¸Žæ–‡æ¡£**
   - ç›¸å…³ä»£ç å·²è‡ªåŠ¨ commitï¼Œæ–‡æ¡£ã€lessonsã€ä»»åŠ¡æ¿å‡å·²åŒæ­¥æ›´æ–°ã€‚

4. **é—ç•™é—®é¢˜ä¸Žå»ºè®®**
   - backend/library/market/pypi_test.go å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå»ºè®®åŽç»­å•ç‹¬ä¿®å¤ã€‚
   - Redis dump.rdb æ–‡ä»¶å‡ºçŽ°åœ¨æ ¹ç›®å½•ï¼Œå±žæ­£å¸¸çŽ°è±¡ï¼Œå¯é€šè¿‡é…ç½®è°ƒæ•´ã€‚
   - è‹¥éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ã€æ”¯æŒå¤šç”¨æˆ· tokenã€å‰ç«¯ token é…ç½®ç­‰ï¼Œå¯åŽç»­è¡¥å……ã€‚

# MCP Service Marketplace Enhancements & Fixes

## Background and Motivation
The project aims to enhance the service marketplace UI/UX, particularly around service installation involving environment variables.
Key requirements:
1.  If backend API `/mcp_market/install_or_add_service` indicates missing environment variables (e.g., `FIRECRAWL_API_KEY`), the frontend should display a modal for the user to input these variables, rather than just showing a toast message.
2.  The backend API was updated to return `{ success: true, data: { required_env_vars: [...] } }` (HTTP 200) when env vars are missing, instead of a 400 error.
3.  Frontend should handle this response by showing an `EnvVarInputModal`.
4.  Users should be able to cancel the modal, and the install button should reset to an "Install" state (not get stuck on "Installing...").
5.  When users submit the modal with entered variables, these variables must be correctly included in the subsequent installation API request.

## Key Challenges and Analysis
- **API Contract Synchronization:** Ensuring frontend and backend agree on response structures for missing env vars. (Initially an issue, now backend returns 200 with `required_env_vars` in `data`).
- **State Management for Modal:** Correctly managing visibility (`envModalVisible`), missing variable names (`missingVars`), and temporarily held variables (`pendingEnvVars`, `pendingServiceId`) in `ServiceMarketplace.tsx`.
- **Store State for Installation Task:** The `installTasks` in `marketStore.ts` (Zustand) tracks the status of each installation. This status (`installing`, `success`, `error`, `idle`) dictates UI elements like button states.
- **Recursive Installation Flow:** When the modal is submitted, `handleEnvModalSubmit` calls `handleInstallService` again. This recursive call needs to:
    - Have its installation status correctly reset (e.g., to 'idle' in `installTasks`) before the recursive call to avoid "already in progress" errors from the store.
    - Correctly carry forward both previously accumulated `pendingEnvVars` and the new `userInputVars` from the modal.
- **Variable Propagation:** Ensuring the variables entered by the user in the modal (`userInputVars`) are correctly merged with any `pendingEnvVars` and passed through `handleInstallService` to the `installService` action in the store, and finally included in the `user_provided_env_vars` field of the API request body. The user reported an issue where newly entered variables were not appearing in the submission.

## High-level Task Breakdown
1.  **Feature: Environment Variable Input Modal** - Task File: `.cursor/feature-env-var-modal.md` (Largely completed)
    *   Backend API adjustment for env var responses.
    *   Frontend `EnvVarInputModal` component creation.
    *   Logic in `ServiceMarketplace.tsx` to show modal.
    *   Type and data flow fixes in `marketStore.ts` and API calls.
2.  **BugFix: Install Button Stuck on "Installing..." after Modal Cancel** - Task File: `.cursor/bugfix-install-button-stuck.md` (Completed)
    *   Reset `installTasks[serviceId].status` to 'idle' when modal is cancelled.
3.  **BugFix: Variables Not Submitted After Modal Input** - Task File: `.cursor/fix-env-var-submission.md` (Active)
    *   Verify variable capture in Modal.
    *   Verify variable merging and passing in `ServiceMarketplace.tsx`.
    *   Verify variable reception and usage in `marketStore.ts`.
    *   Ensure the HTTP request payload is correct.

## Project Status Board
- **Active Task File:** `.cursor/fix-env-var-submission.md`
- `feature-env-var-modal.md`: Completed
- `bugfix-install-button-stuck.md`: Completed

## Executor's Feedback or Assistance Requests

- [2024-06-10] SSE ä»£ç† mock æµ‹è¯•ç”¨ä¾‹å·²è¡¥å…¨ï¼Œæµ‹è¯•éœ€åœ¨ç”¨ä¾‹å‰åˆå§‹åŒ– MCPServiceDBï¼ˆmodel.MCPServiceInitï¼‰ï¼Œå¦åˆ™ CreateService ä¼š panicã€‚å·²åœ¨ active task file è®°å½•æ­¤ä¾èµ–ã€‚

## Lessons
- Axios interceptors can alter the shape of API responses; ensure store actions and component logic are consistent with the actual data structure returned by the API client.
- When dealing with multi-step operations (like install -> input env -> re-install), carefully manage and reset intermediate states (e.g., installation task status) to allow the flow to proceed correctly.
- Explicitly log data at each step of a complex flow to verify propagation.

## User Specified Lessons
- Include info useful for debugging in the program output.
- Read the file before you try to edit it.
- Always ask before using the -force git command

### æœåŠ¡å¸‚åœºä¸ŽæœåŠ¡ç®¡ç†åˆ†å·¥ã€çŽ¯å¢ƒå˜é‡é…ç½®ä¸Žæƒé™æœºåˆ¶ï¼ˆ2024-05-XX è¡¥å……ï¼‰

æœ¬é˜¶æ®µç›®æ ‡æ˜¯å®žçŽ°æœåŠ¡å¸‚åœºï¼ˆService Marketplaceï¼‰ä¸ŽæœåŠ¡ç®¡ç†ï¼ˆServicesï¼‰é¡µé¢çš„åˆ†å·¥é‡æž„ï¼Œä»¥åŠçŽ¯å¢ƒå˜é‡é…ç½®å¼¹çª—ã€åŽç«¯æŽ¥å£ä¸Žæƒé™æœºåˆ¶çš„å®Œå–„ã€‚å…·ä½“åŒ…æ‹¬ï¼š
- Service Marketplace ä»…åš"å‘çŽ°/å®‰è£…"ï¼Œç§»é™¤"å·²å®‰è£…""PyPI""Recommended"tabï¼Œä»…ä¿ç•™ All/NPMã€‚
- Services é¡µé¢ä¸“æ³¨"ç®¡ç†/é…ç½®/ç»Ÿè®¡"ï¼Œæ•°æ®æºåˆ‡æ¢ä¸º store çš„ fetchInstalledServicesï¼Œæ”¯æŒ"å…¨éƒ¨/Active/Inactive"tabï¼ŒæŒ‰æœåŠ¡çŠ¶æ€è¿‡æ»¤ã€‚
- å®‰è£…æœåŠ¡æ—¶ï¼Œè‹¥åŽç«¯è¿”å›žç¼ºå°‘çŽ¯å¢ƒå˜é‡ï¼Œå‰ç«¯å¼¹å‡º EnvVarInputModal è®©ç”¨æˆ·è¡¥å…¨ã€‚
- æ–°å¢ž ServiceConfigModal ç»„ä»¶ï¼Œæ”¯æŒå±•ç¤º/ç¼–è¾‘æ‰€æœ‰çŽ¯å¢ƒå˜é‡ã€é€é¡¹ä¿å­˜ã€SSE/HTTP endpoint å±•ç¤ºä¸Žä¸€é”®å¤åˆ¶ã€‚
- åŽç«¯æŽ¥å£ /api/mcp_market/installed è¿”å›ž env_vars å­—æ®µï¼ŒPATCH /api/mcp_market/env_var æ”¯æŒå•ç‹¬ä¿å­˜æœåŠ¡çŽ¯å¢ƒå˜é‡ã€‚
- çŽ¯å¢ƒå˜é‡æ— é»˜è®¤å€¼ï¼Œåªæœ‰"ç®¡ç†å‘˜å…±äº«"ä¸Ž"ç”¨æˆ·ç§æœ‰"ä¸¤ç§æ¨¡å¼ï¼Œæƒé™ä¸Žæ•°æ®æµåŒæ­¥è°ƒæ•´ã€‚

## Key Challenges and Analysis

### æœåŠ¡å¸‚åœº/æœåŠ¡ç®¡ç†åˆ†å·¥ä¸ŽçŽ¯å¢ƒå˜é‡æƒé™æœºåˆ¶ï¼ˆ2024-05-XX è¡¥å……ï¼‰

- å‰åŽç«¯éœ€ä¸¥æ ¼åŒºåˆ†"å‘çŽ°/å®‰è£…"ä¸Ž"ç®¡ç†/é…ç½®"ä¸¤å¤§é¡µé¢çš„æ•°æ®æµå’Œäº¤äº’ï¼Œé¿å…æ··æ·†ã€‚
- çŽ¯å¢ƒå˜é‡é…ç½®éœ€æ”¯æŒ"ç®¡ç†å‘˜å…±äº«"ä¸Ž"ç”¨æˆ·ç§æœ‰"ä¸¤çº§ï¼Œæ— é»˜è®¤å€¼ï¼Œä¼˜å…ˆçº§ä¸ºï¼šç”¨æˆ·ç§æœ‰ > ç®¡ç†å‘˜å…±äº« > ç©ºã€‚
- ä»…ç®¡ç†å‘˜å¯åˆ‡æ¢å…±äº«çŠ¶æ€ï¼Œæ™®é€šç”¨æˆ·åªèƒ½å¡«å†™è‡ªå·±çš„å€¼ï¼Œä¸èƒ½æ›´æ”¹å…±äº«çŠ¶æ€ã€‚
- åŽç«¯éœ€åœ¨ ConfigService å¢žåŠ  is_shared å­—æ®µï¼ŒæŽ¥å£æŸ¥è¯¢/ä¿å­˜æ—¶éœ€åšæƒé™æ ¡éªŒã€‚
- å‰ç«¯ ServiceConfigModal éœ€æ ¹æ®æƒé™æ¸²æŸ“é”å›¾æ ‡ã€åªè¯»/å¯ç¼–è¾‘çŠ¶æ€ã€‚
- å¤šç”¨æˆ·åœºæ™¯ä¸‹éœ€ç¡®ä¿æ•°æ®éš”ç¦»ä¸Žæƒé™å®‰å…¨ã€‚
- UI éœ€ä¼˜åŒ–å¼¹çª—ã€æŒ‰é’®ã€endpoint å¤åˆ¶ç­‰ç»†èŠ‚ï¼Œæå‡äº¤äº’ä½“éªŒã€‚

## High-level Task Breakdown

### æœåŠ¡å¸‚åœº/æœåŠ¡ç®¡ç†åˆ†å·¥ä¸ŽçŽ¯å¢ƒå˜é‡æƒé™æœºåˆ¶ï¼ˆ2024-05-XX è¡¥å……ï¼‰

- Marketplace é¡µé¢é‡æž„ï¼Œä»…ä¿ç•™ All/NPM tabï¼Œèšç„¦æœåŠ¡å‘çŽ°ä¸Žå®‰è£…ã€‚
- Services é¡µé¢é‡æž„ï¼Œæ•°æ®æºåˆ‡æ¢ä¸º store çš„ fetchInstalledServicesï¼Œæ”¯æŒæŒ‰çŠ¶æ€è¿‡æ»¤ã€‚
- çŽ¯å¢ƒå˜é‡å¼¹çª—ä¸Žé…ç½®ï¼š
    - å®‰è£…æœåŠ¡æ—¶ç¼ºå°‘å˜é‡å¼¹ EnvVarInputModalã€‚
    - Services é¡µé¢æ”¯æŒ ServiceConfigModalï¼Œå±•ç¤º/ç¼–è¾‘æ‰€æœ‰å˜é‡ï¼Œé€é¡¹ä¿å­˜ã€‚
    - æ”¯æŒ endpoint ä¸€é”®å¤åˆ¶ä¸Žåé¦ˆã€‚
- åŽç«¯æŽ¥å£è°ƒæ•´ï¼š
    - /api/mcp_market/installed è¿”å›ž env_vars å­—æ®µã€‚
    - PATCH /api/mcp_market/env_var æ”¯æŒå•ç‹¬ä¿å­˜å˜é‡ï¼Œå‚æ•° service_id, var_name, var_valueã€‚
    - ConfigService å¢žåŠ  is_shared å­—æ®µï¼Œæƒé™æ ¡éªŒä¸Žä¼˜å…ˆçº§é€»è¾‘ã€‚
- æƒé™ä¸Žå…±äº«æœºåˆ¶ï¼š
    - ç®¡ç†å‘˜å¯åˆ‡æ¢å˜é‡å…±äº«çŠ¶æ€ï¼Œæ™®é€šç”¨æˆ·åªèƒ½å¡«å†™ç§æœ‰å€¼ã€‚
    - æŸ¥è¯¢ä¼˜å…ˆçº§ï¼šç”¨æˆ·ç§æœ‰ > ç®¡ç†å‘˜å…±äº« > ç©ºã€‚
    - å‰ç«¯ UI æŒ‰æƒé™æ¸²æŸ“äº¤äº’ã€‚
- ä»»åŠ¡æ–‡æ¡£ä¸ŽçŠ¶æ€åŒæ­¥ï¼Œä¾¿äºŽåŽç»­è¿­ä»£ã€‚

## Project Status Board

Active Task File: feature-marketplace-services-split.md

- feature-marketplace-services-split.md: æœåŠ¡å¸‚åœº/æœåŠ¡ç®¡ç†åˆ†å·¥ä¸ŽçŽ¯å¢ƒå˜é‡æƒé™æœºåˆ¶é‡æž„ï¼Œè¿›è¡Œä¸­ã€‚

- æœåŠ¡çŽ¯å¢ƒå˜é‡ç¼–è¾‘åŠŸèƒ½å·²å®Œæˆï¼ŒPATCH /api/mcp_market/env_var è·¯ç”±å·²æ³¨å†Œï¼Œå‰ç«¯ UI/äº¤äº’/ä¿å­˜å‡å·²é€šè¿‡éªŒæ”¶ã€‚

## Background and Motivation

è¿‘æœŸå‘çŽ°æœåŠ¡å¸è½½åŠŸèƒ½å¼‚å¸¸ï¼Œè¡¨çŽ°ä¸ºå‰ç«¯å‘èµ·å¸è½½è¯·æ±‚æ—¶é¡µé¢å¡åœ¨ loadingï¼Œè¿”å›ž HTML è€Œéž JSONã€‚ç»åˆ†æžï¼ŒåŽŸå› æ˜¯å‰ç«¯è¯·æ±‚çš„å¸è½½ API è·¯ç”±ï¼ˆDELETE /api/mcp_market/services/{serviceId}/uninstallï¼‰ä¸ŽåŽç«¯å®žé™…æ³¨å†Œçš„ handler è·¯ç”±ï¼ˆPOST /api/mcp_market/uninstallï¼‰ä¸ä¸€è‡´ï¼Œå¯¼è‡´è¯·æ±‚æœªå‘½ä¸­åŽç«¯ handlerï¼Œè¢« Vite fallback åˆ°å‰ç«¯ SPAã€‚

## Key Challenges and Analysis

- å‰ç«¯å’ŒåŽç«¯å¸è½½æŽ¥å£è·¯ç”±é£Žæ ¼ä¸ä¸€è‡´ï¼Œå‰ç«¯é‡‡ç”¨ RESTful DELETE è·¯å¾„å‚æ•°ï¼ŒåŽç«¯é‡‡ç”¨ POST + JSON bodyã€‚
- å…¶ä»–æŽ¥å£å‡æ­£å¸¸ï¼Œæ˜¯å› ä¸ºè·¯ç”±å’Œ handler æ³¨å†Œä¸€è‡´ã€‚
- éœ€ç»Ÿä¸€å‰åŽç«¯å¸è½½æŽ¥å£çš„è·¯ç”±å’Œæ–¹æ³•ï¼ŒæŽ¨èå‰ç«¯é€‚é…åŽç«¯ã€‚

## High-level Task Breakdown

- [ ] ä¿®å¤å‰ç«¯å¸è½½æŽ¥å£è°ƒç”¨æ–¹å¼ï¼Œç¡®ä¿ä¸ŽåŽç«¯ handler å¯¹é½ã€‚
- [ ] æµ‹è¯•å¸è½½æµç¨‹ï¼Œç¡®ä¿ UI/çŠ¶æ€/åé¦ˆæ­£å¸¸ã€‚

## Project Status Board

Active Task File: `.cursor/feature-uninstall-service-tasks.md`

Relevant Task Files:
*   `.cursor/feature-uninstall-service-tasks.md`: Service Uninstallation feature (Active).

# Meta-Task: Generate Description for plan-mode.mdc

## Background and Motivation

The user has requested a description to be generated for the `plan-mode.mdc` rule itself. This rule is crucial as it defines how the Planner agent should operate, emphasizing thorough exploration before planning.

## Key Challenges and Analysis

- The main challenge is to create a description that is both concise and accurately captures the comprehensive nature and intent of `plan-mode.mdc`.
- It must reflect the mandatory nature of Phase 1 (Contextual Exploration & Analysis) and the specific outputs required (Context Summary, tool usage).
- It should also summarize Phase 2 (Formulate a Plan) and its outputs (updates to scratchpad, creation of task files with `Task Type`).

## High-level Task Breakdown

### 1. Generate Description for `plan-mode.mdc`
    - **Task**: Generate a comprehensive description for the `plan-mode.mdc` rule.
    - **Details**: See `.cursor/generate-description-plan-mode-tasks.md`.
    - **Task Type**: `new-feat` (creating a new descriptive artifact).

## Project Status Board

Previous Active Task File: `.cursor/feature-uninstall-service-tasks.md`
**Active Task File: `.cursor/generate-description-plan-mode-tasks.md`**

Relevant Task Files:
*   `.cursor/login-refactor-tasks.md`: Login experience refactor (All tasks completed).
*   `.cursor/feature-uninstall-service-tasks.md`: Service Uninstallation feature.
*   `.cursor/feature-service-card-refine.md`: (Status: Completed)
*   `.cursor/feature-marketplace-ui-finalization.md`: Frontend work to integrate ServiceCard.tsx and test marketplace UI.
*   `.cursor/generate-description-plan-mode-tasks.md`: Meta-task to generate description for `plan-mode.mdc` (Active).

## Executor's Feedback or Assistance Requests

Waiting for the Executor to generate the description based on the plan.

## Lessons
*(Existing lessons remain)*

## User Specified Lessons
*(Existing user specified lessons remain)*

---

## Background and Motivation

The system experiences deadlocks at runtime, particularly when services like `exa-mcp-server` are initialized. This is due to the `ServiceManager` holding a write lock during service registration, while the actual startup of `Stdio` type services (within `ServiceFactory` -> `getOrCreateStdioToSSEHandler`) can block indefinitely if the configured command fails to start or initialize correctly.
The immediate trigger for `exa-mcp-server` is that its command is configured as `"exa-mcp-server"` directly, without `npx` (which might be needed if it's an npm package not globally installed), and its `PackageManager` is `"manual"`.
The core issue is twofold:
1. Potentially incorrect command/environment setup for `Stdio` services like `exa-mcp-server`.
2. Lack of robust error handling (e.g., timeouts, non-blocking initialization) in the stdio process launching mechanism, leading to `RegisterService` holding a lock for too long.

This plan aims to make the `Stdio` service startup more robust and configurable.

## Key Challenges and Analysis

- The `exa-mcp-server` is seeded with `Command: "exa-mcp-server"` and `PackageManager: "manual"`. If it requires `npx`, this configuration is incorrect.
- The function `getOrCreateStdioToSSEHandler` in `backend/library/proxy/service.go` synchronously calls `mcpclient.NewStdioMCPClient` and `mcpGoClient.Initialize`. If these calls block due to command failure (e.g., not found, exits with error, hangs) or initialization issues, the `ServiceManager`'s write lock is held, causing a deadlock.
- Modifying the command execution needs to consider if `npx` should be universally applied or configurable.
- Adding timeouts to the process initialization requires careful consideration of appropriate durations and ensuring resource cleanup (e.g., `mcpGoClient.Close()`) on failure.
- The fix should prevent indefinite blocking even if a command is misconfigured or fails to install/run, aligning with the user's expectation that command installation failures in production shouldn't cause deadlocks.

## High-level Task Breakdown

- **Task File**: `.cursor/fix-stdio-service-startup-tasks.md`
    - Analyze and correct the command configuration for `exa-mcp-server`.
    - Implement robust startup for `Stdio` services in `getOrCreateStdioToSSEHandler`, including timeouts and error handling.
    - Ensure resources are cleaned up if service startup fails.
    - Test the changes thoroughly.

## Project Status Board

- Active Task File: `.cursor/fix-stdio-service-startup-tasks.md`
- Overall Status: Planning complete for Stdio service startup fix.

# Background and Motivation

æ”¯æŒå¤šç”¨æˆ·è‡ªå®šä¹‰æœåŠ¡é…ç½®ï¼Œæå‡ç³»ç»Ÿçµæ´»æ€§ä¸Žå®‰å…¨æ€§ã€‚é€šè¿‡ handler åŠ¨æ€åˆ›å»ºä¸Žç¼“å­˜ï¼Œå…¼é¡¾æ€§èƒ½ä¸Žéš”ç¦»æ€§ã€‚

# Key Challenges and Analysis

- ç”¨æˆ· ENV åˆå¹¶ä¼˜å…ˆçº§ä¸Žå†²çªå¤„ç†ã€‚
- handler ç”Ÿå‘½å‘¨æœŸä¸Žèµ„æºç®¡ç†ï¼ˆåŽç»­å¯æ‰©å±•ï¼‰ã€‚
- å•å…ƒæµ‹è¯•çš„å¯ mock æ€§ä¸Žè¦†ç›–é¢ã€‚

# High-level Task Breakdown

- ç”¨æˆ·ç‰¹å®š ENV æŸ¥è¯¢ä¸Žåˆå¹¶ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰
- handler åŠ¨æ€åˆ›å»ºä¸Žç¼“å­˜ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰
- å•å…ƒæµ‹è¯•è¦†ç›–ç”¨æˆ·ç‰¹å®š handler è·¯å¾„ä¸Žé…ç½®åˆå¹¶ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰
- SSEProxyHandler ç»“æž„é‡æž„ï¼Œé€»è¾‘åˆ†ç¦»ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰
- handler ç”Ÿå‘½å‘¨æœŸä¸Žèµ„æºé‡Šæ”¾æœºåˆ¶è®¾è®¡ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰
- handler ç¼“å­˜è¿‡æœŸä¸Žè‡ªåŠ¨æ¸…ç†å®žçŽ°ï¼ˆè§ .cursor/feature-user-service-env-tasks.mdï¼‰

# Project Status Board

- Active Task File: .cursor/feature-user-service-env-tasks.md
- å½“å‰è¿›åº¦ï¼šç”¨æˆ·ç‰¹å®š handler é€»è¾‘ä¸Žå•å…ƒæµ‹è¯•å·²å®Œæˆï¼Œhandler ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸ºåŽç»­ä»»åŠ¡ã€‚

### User-Specific Service ENV Support & Handler Refactor (feature-user-service-env-tasks.md)
- **Status:** In Progress
- **Summary:** Allow users to configure independent ENVs for services, dynamically creating and caching handlers. This involved refactoring `SSEProxyHandler`, adding `GetUserSpecificEnvs`, and updating tests.
- **Next Steps:** Implement handler lifecycle management and cache eviction.

### MCPService Model and StdioConfig Refactor (feature-mcp-service-refactor-tasks.md)
- **Status:** Planning
- **Summary:** Remove deprecated config fields (`DefaultAdminConfigValues`, `AdminConfigSchema`, `UserConfigSchema`) from `MCPService`. Modify `stdioConf` population in `proxy/service.go` to use `MCPService.Command`, `MCPService.ArgsJSON`, and `MCPService.DefaultEnvsJSON`. Update MCPService API handlers to set `Command` based on `PackageManager`.
- **Next Steps:** Execute the plan: modify models, service logic, API handlers, and update tests.

## Key Challenges and Analysis

### Previous: User-Specific ENV & Handler Management
- Ensuring correct precedence of ENV variables (user > service default > stdioConf default).
- Dynamically creating and caching `http.Handler` instances per user and service, or globally.
- Refactoring `SSEProxyHandler` for clarity by separating user-specific and global handler logic.
- Mocking dependencies effectively in unit tests for `proxy_handler.go`.

### Current: MCPService Model and StdioConfig Refactor
- **Field Removal:** Identifying and safely removing all usages of `DefaultAdminConfigValues`, `AdminConfigSchema`, and `UserConfigSchema`.
- **StdioConfig Population:** Modifying `getOrCreateStdioToSSEHandler` and `defaultNewStdioSSEHandlerUncached` in `backend/library/proxy/service.go` to construct `model.StdioConfig` using:
    - `mcpDBService.Command` for `StdioConfig.Command`.
    - `mcpDBService.ArgsJSON` (string containing JSON array of strings) for `StdioConfig.Args`. Requires JSON unmarshalling.
    - `mcpDBService.DefaultEnvsJSON` (string containing JSON map of string to string) for `StdioConfig.Env`. Requires unmarshalling and formatting into `[]string{"KEY=VALUE"}`. This part is largely existing but needs to be verified in the new flow.
- **API Handler Logic:** Updating `CreateMCPService` and `UpdateMCPService` in `backend/api/handler/mcp_service.go` to set `service.Command` based on `service.PackageManager`:
    - If `PackageManager == "npm"`, set `Command = "npx"`.
    - If `PackageManager == "pypi"`, set `Command = "uvx"`.
    - This logic should be applied *before* saving the service.
- **Test Updates:** Significant updates will be required for `backend/api/handler/proxy_handler_test.go` as it currently relies on `DefaultAdminConfigValues` for setting up test scenarios. Tests will need to be adapted to use the new `Command` and `ArgsJSON` fields.
- **Error Handling:** Ensuring proper error handling during JSON unmarshalling of `ArgsJSON` and `DefaultEnvsJSON`.
- **Impact on Seeder:** The commented-out seeder logic in `backend/model/mcp_service.go` will need updating if it's to be used.
- **Data Migration (Out of Scope for AI):** No explicit data migration steps for existing database records are included in this plan. This would typically involve a separate migration script or process.

## High-level Task Breakdown

### 1. Remove deprecated fields from `MCPService` model and update seeder.
### 2. Modify `proxy/service.go` to use new fields for `StdioConfig`.
### 3. Update `handler/mcp_service.go` API for `PackageManager` logic.
### 4. Update tests in `handler/proxy_handler_test.go`.
### 5. Update `handler/proxy_handler.go` to reflect new `StdioConfig` sourcing.

## Project Status Board

- **Active Task File:** `.cursor/feature-mcp-service-refactor-tasks.md`
- **Overall Progress:** User-specific ENV support is mostly complete. Starting refactor of MCPService model and StdioConfig.
- **Relevant Task Files:**
  - `.cursor/feature-user-service-env-tasks.md` (In Progress - nearing completion of currently planned items)
  - `.cursor/feature-mcp-service-refactor-tasks.md` (Newly Active)