name: CI/CD Pipeline

on:
  push:
    branches: [ main, github_main ]
    tags:
      - 'v*'  # Trigger on version tags like v0.3.3
  pull_request:
    branches: [ main, github_main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for release'
        required: false
        default: ''



jobs:
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Create dummy frontend dist for Go linting
      run: |
        mkdir -p frontend/dist
        echo "<html><body>dummy file</body></html>" > frontend/dist/index.html

    - name: Lint Go code
      run: |
        go vet ./...
        go fmt ./...
        # Check if there are any formatting changes
        if [ -n "$(git diff --name-only)" ]; then
          echo "Code is not properly formatted. Please run 'go fmt ./...'"
          git diff
          exit 1
        fi

    - name: Lint frontend code
      run: |
        cd frontend
        npm run lint

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Install dependencies
      run: go mod download

    - name: Create test database directory
      run: mkdir -p data

    - name: Create dummy frontend dist for Go tests
      run: |
        mkdir -p frontend/dist
        echo "<html><body>dummy file</body></html>" > frontend/dist/index.html

    - name: Run Go tests
      env:
        GIN_MODE: test
      run: |
        go test -v -race -coverprofile=coverage.out ./...

    - name: Generate coverage report
      run: |
        go tool cover -html=coverage.out -o coverage.html

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: |
          coverage.out
          coverage.html

  build:
    name: Build Binaries
    runs-on: ${{ matrix.runner }}
    needs: [lint, test-backend]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            runner: ubuntu-latest
          - goos: linux
            goarch: arm64
            runner: ubuntu-latest
          - goos: darwin
            goarch: amd64
            runner: macos-latest
          - goos: darwin
            goarch: arm64
            runner: macos-14
          - goos: windows
            goarch: amd64
            runner: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Read version
      id: version
      run: |
        if [ -f VERSION ]; then
          VERSION=$(cat VERSION)
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        REACT_APP_VERSION=${{ steps.version.outputs.version }} npm run build

    - name: Install mingw for Windows CGO
      if: matrix.goos == 'windows'
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p release
        OUTPUT_NAME="one-mcp-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}"

        if [ "${{ matrix.goos }}" = "windows" ]; then
          export CGO_ENABLED=1
          export CC=x86_64-w64-mingw32-gcc
          OUTPUT_NAME="${OUTPUT_NAME}.exe"
        elif [ "${{ matrix.goos }}" = "darwin" ]; then
          export CGO_ENABLED=1
        else
          export CGO_ENABLED=0
        fi

        go build -ldflags="-s -w -X 'one-mcp/common.Version=${{ steps.version.outputs.version }}'" \
          -o "release/${OUTPUT_NAME}" main.go

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
        path: release/
        retention-days: 30


  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build]
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '') || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -name "one-mcp-*" -type f -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        files: release-assets/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap Formula
    runs-on: ubuntu-latest
    needs: [release]
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '') || startsWith(github.ref, 'refs/tags/v')
    env:
      TAP_REPO: burugo/homebrew-tap
    steps:
    - uses: actions/checkout@v4

    - name: Resolve release version
      id: release_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION_TAG="${{ github.event.inputs.version }}"
        else
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
        fi

        if [[ "$VERSION_TAG" != v* ]]; then
          VERSION_TAG="v$VERSION_TAG"
        fi

        VERSION_NO_V="${VERSION_TAG#v}"

        echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
        echo "version_no_v=$VERSION_NO_V" >> $GITHUB_OUTPUT

    - name: Download release assets for Homebrew formula
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p release-assets
        gh release download "${{ steps.release_version.outputs.version_tag }}" \
          --repo "${{ github.repository }}" \
          --pattern "one-mcp-${{ steps.release_version.outputs.version_tag }}-darwin-amd64" \
          --pattern "one-mcp-${{ steps.release_version.outputs.version_tag }}-darwin-arm64" \
          --pattern "one-mcp-${{ steps.release_version.outputs.version_tag }}-linux-amd64" \
          --pattern "one-mcp-${{ steps.release_version.outputs.version_tag }}-linux-arm64" \
          --dir release-assets

    - name: Calculate SHA256 checksums
      id: checksum
      run: |
        SHA256_DARWIN_AMD64=$(shasum -a 256 "release-assets/one-mcp-${{ steps.release_version.outputs.version_tag }}-darwin-amd64" | awk '{print $1}')
        SHA256_DARWIN_ARM64=$(shasum -a 256 "release-assets/one-mcp-${{ steps.release_version.outputs.version_tag }}-darwin-arm64" | awk '{print $1}')
        SHA256_LINUX_AMD64=$(shasum -a 256 "release-assets/one-mcp-${{ steps.release_version.outputs.version_tag }}-linux-amd64" | awk '{print $1}')
        SHA256_LINUX_ARM64=$(shasum -a 256 "release-assets/one-mcp-${{ steps.release_version.outputs.version_tag }}-linux-arm64" | awk '{print $1}')

        echo "sha256_darwin_amd64=$SHA256_DARWIN_AMD64" >> $GITHUB_OUTPUT
        echo "sha256_darwin_arm64=$SHA256_DARWIN_ARM64" >> $GITHUB_OUTPUT
        echo "sha256_linux_amd64=$SHA256_LINUX_AMD64" >> $GITHUB_OUTPUT
        echo "sha256_linux_arm64=$SHA256_LINUX_ARM64" >> $GITHUB_OUTPUT

    - name: Update formula in tap repository
      run: |
        git clone "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/${TAP_REPO}.git" tap-repo
        cp Formula/one-mcp.rb tap-repo/Formula/one-mcp.rb

        ruby -i -pe 'gsub(/^  version ".*"$/, "  version \"${{ steps.release_version.outputs.version_no_v }}\"")' tap-repo/Formula/one-mcp.rb
        ruby -i -pe 'gsub("REPLACE_WITH_DARWIN_AMD64_SHA256", "${{ steps.checksum.outputs.sha256_darwin_amd64 }}")' tap-repo/Formula/one-mcp.rb
        ruby -i -pe 'gsub("REPLACE_WITH_DARWIN_ARM64_SHA256", "${{ steps.checksum.outputs.sha256_darwin_arm64 }}")' tap-repo/Formula/one-mcp.rb
        ruby -i -pe 'gsub("REPLACE_WITH_LINUX_AMD64_SHA256", "${{ steps.checksum.outputs.sha256_linux_amd64 }}")' tap-repo/Formula/one-mcp.rb
        ruby -i -pe 'gsub("REPLACE_WITH_LINUX_ARM64_SHA256", "${{ steps.checksum.outputs.sha256_linux_arm64 }}")' tap-repo/Formula/one-mcp.rb

        cd tap-repo
        if git diff --quiet -- Formula/one-mcp.rb; then
          exit 0
        fi

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add Formula/one-mcp.rb
        git commit -m "chore: update one-mcp formula to ${{ steps.release_version.outputs.version_tag }}"
        git push origin HEAD